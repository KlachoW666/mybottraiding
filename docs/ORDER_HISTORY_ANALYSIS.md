# Анализ ордеров и внесённые корректировки

## Область анализа

- **Открытие позиций** — `openPosition`, валидация сигнала и цены входа
- **Закрытие позиций** — `closePosition`, ручное и авто (SL/TP, trailing, по времени)
- **История сделок** — загрузка/сохранение из localStorage, отображение в таблице
- **Статистика** — P&L, Win Rate, Profit Factor, лучшая/худшая сделка

---

## Выявленные проблемы и исправления

### 1. Нулевая/невалидная цена выхода (closePrice = 0)

**Проблема:** При закрытии позиции иногда подставлялась нулевая или невалидная цена (например, не обновилась котировка). В историю писался `closePrice: 0`, а P&L для SHORT считался как `(openPrice - 0) / openPrice * size * leverage` → завышенная «прибыль».

**Исправления (ранее):**
- В `closePosition`: если цена закрытия невалидна или ≤ 0, подставляется `openPrice` (P&L = 0).
- В таблице истории: при невалидном closePrice показывается «—» для цены выхода и P&L.

### 2. Загрузка истории из localStorage

**Проблема:** Старые записи с `closePrice: 0` и некорректным P&L оставались в истории и искажали статистику.

**Исправления:**
- **Нормализация при загрузке:** все числовые поля (openPrice, closePrice, size, pnl, pnlPercent, leverage) приводятся через `num(v, fallback)`. Для записей с невалидным closePrice (≤ 0) при загрузке обнуляются `pnl` и `pnlPercent`.
- **Позиции при загрузке:** позиции с `openPrice ≤ 0` отфильтровываются. У остальных `openPrice`, `currentPrice`, `size` нормализуются; при невалидном `currentPrice` подставляется `openPrice`.

### 3. Статистика (баланс, Win Rate, Profit Factor)

**Проблема:** Win Rate, Gross Profit/Loss, Best/Worst Trade считались по всей истории, включая записи с невалидным closePrice и завышенным P&L.

**Исправления:**
- Введён `validClosePrice(h)` — запись считается валидной, если `closePrice` — число, конечное и > 0.
- Все метрики считаются только по **валидным** сделкам: `validHistory = history.filter(validClosePrice)`. Win/Loss, grossProfit, grossLoss, bestTrade, worstTrade, profitFactor, avgWin, avgLoss используют только `validHistory`.

### 4. Сохранение в localStorage

**Проблема:** При сохранении в localStorage могли попадать NaN/Infinity (например, из-за ошибок расчёта), что ломало последующую загрузку.

**Исправления:**
- Функция `sanitizeNum(n)`: возвращает 0 для нечисловых или неконечных значений.
- При сохранении все числовые поля (balance, initialBalance, openPrice, closePrice, size, pnl, pnlPercent и т.д.) проходят через `sanitizeNum` перед записью.

### 5. Открытие позиции с нулевой ценой входа

**Проблема (исправлено ранее):** При `signal.entry_price = 0` или невалидном значении позиция всё равно открывалась, что ломало расчёт P&L при закрытии.

**Исправление:** В `openPosition` добавлена проверка: при невалидной или нулевой цене входа функция выходит без открытия позиции.

---

## Итог

- **При загрузке:** история и позиции нормализуются; невалидные closePrice/pnl обнуляются; позиции с нулевым openPrice отбрасываются.
- **При закрытии:** не используется нулевая/невалидная цена; при необходимости подставляется openPrice.
- **При сохранении:** все числа санитизируются (NaN/Infinity → 0).
- **Статистика:** считается только по сделкам с валидным closePrice.
- **Отображение:** для записей с невалидным closePrice в таблице показывается «—» для цены выхода и P&L.

После перезапуска приложения при первой загрузке страницы история будет автоматически приведена к корректному виду (старые «битые» записи перестанут влиять на статистику, в таблице для них будет «—»).
